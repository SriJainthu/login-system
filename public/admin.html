<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Symposium 2026</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<style>
        /* ---------- Existing Body & Layout ---------- */
        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
            color: #fff;
            padding: 30px;
            margin: 0;
            min-height: 100vh;
        }

        h1 {
            text-align: center;
            margin-bottom: 20px;
            font-size: 36px;
            letter-spacing: 3px;
            text-transform: uppercase;
            text-shadow: 0 0 20px rgba(0, 198, 255, 0.6);
        }

        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        /* ---------- STATS CARDS ---------- */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 10px;
        }

        .stat-card {
            background: rgba(0, 198, 255, 0.1);
            border: 1px solid rgba(0, 198, 255, 0.3);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            backdrop-filter: blur(5px);
            transition: transform 0.3s ease;
        }
        .stat-card:hover { transform: translateY(-5px); }

        .stat-card h3 { margin: 0; font-size: 14px; text-transform: uppercase; color: #aaa; }
        .stat-card p { margin: 10px 0 0; font-size: 28px; font-weight: bold; color: #00c6ff; }

        /* ---------- TOAST NOTIFICATION ---------- */
        #toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(to right, #2ecc71, #27ae60);
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            display: none;
            z-index: 10000;
            font-weight: bold;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes tableFade {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animated-row { animation: tableFade 0.4s ease forwards; }

        .top-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            align-items: stretch;
        }

        .card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.4);
            display: flex;
            flex-direction: column;
        }

        .chart-header, .section-header {
            margin-bottom: 20px;
            font-size: 16px;
            font-weight: bold;
            color: #00c6ff;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            border-bottom: 1px solid rgba(0, 198, 255, 0.2);
            padding-bottom: 10px;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            flex-grow: 1;
        }

        .filters { display: flex; flex-direction: column; gap: 12px; }

        .export-settings {
            display: flex;
            flex-direction: column;
            gap: 10px;
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 12px;
            justify-content: center;
        }

        .admin-config-box {
            margin-top: 5px;
            padding: 12px;
            border: 1px solid rgba(0, 198, 255, 0.3);
            border-radius: 12px;
            background: rgba(0, 198, 255, 0.05);
            transition: 0.3s;
        }

        .needs-confirm {
            border-color: #f1c40f;
            background: rgba(241, 196, 15, 0.1);
        }

        input, select, textarea, .btn {
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.08);
            color: white;
            font-size: 14px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            width: 100%;
            box-sizing: border-box;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #00c6ff;
            background: #1a2a33;
            transform: scale(1.01);
        }

        .btn {
            background: linear-gradient(to right, #00c6ff, #0072ff);
            color: white;
            font-weight: bold;
            cursor: pointer;
            border: none;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn:hover { 
            filter: brightness(1.2); 
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 198, 255, 0.4);
        }
        
        .btn:active { transform: translateY(0); }

        .btn-csv { background: linear-gradient(to right, #2ecc71, #27ae60); }
        .btn-confirm { background: linear-gradient(to right, #2ecc71, #27ae60); margin-top: 10px; display: none; padding: 8px; }

        /* ---------- DYNAMIC EVENT MANAGER STYLES ---------- */
        .event-manager-card { grid-column: span 2; }
        .event-form { display: flex; gap: 15px; margin-bottom: 25px; align-items: flex-end; }
        .event-input-group { flex: 1; }
        .event-input-group label { display: block; font-size: 11px; color: #00c6ff; margin-bottom: 5px; text-transform: uppercase; font-weight: bold; }
        
        .added-events-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            max-height: 400px;
            overflow-y: auto;
            padding: 5px;
        }
        .event-item {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.1);
            padding: 18px;
            border-radius: 15px;
            position: relative;
            transition: 0.3s;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .event-item:hover {
            background: rgba(255,255,255,0.07);
            border-color: #00c6ff;
        }
        .event-item h4 { margin: 0 0 8px 0; color: #00ffae; font-size: 18px; padding-right: 25px;}
        .event-item p { margin: 0; font-size: 13px; color: #bbb; line-height: 1.5; }
        
        .delete-event {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255, 75, 43, 0.2);
            border: 1px solid #ff4b2b;
            color: #ff4b2b;
            border-radius: 8px;
            width: 28px;
            height: 28px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.3s;
        }
        .delete-event:hover { background: #ff4b2b; color: white; }

        /* ---------- MODAL ---------- */
        .modal-overlay {
            position: fixed;
            top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(8px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 20000;
        }
        .modal-box {
            background: #1a2a33;
            padding: 30px;
            border-radius: 20px;
            border: 1px solid #00c6ff;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        .modal-btns { display: flex; gap: 15px; margin-top: 25px; }
        .btn-secondary { background: #444; color: white; border: none; cursor: pointer; }

        /* ---------- TABLE ---------- */
        .table-container {
            overflow-x: auto;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            min-height: 200px;
        }

        table { width: 100%; border-collapse: separate; border-spacing: 0; color: #333; }
        th { 
            background: #1a2a33; 
            color: #00c6ff; 
            padding: 18px; 
            text-align: center; 
            text-transform: uppercase; 
            font-size: 13px;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        td { padding: 15px; border-bottom: 1px solid #eee; text-align: center; }
        
        /* Group View Rowspan Column styling */
        td[rowspan] {
            background: rgba(0, 198, 255, 0.08);
            color: #0072ff;
            font-weight: 800;
            border-right: 2px solid rgba(0, 198, 255, 0.2);
        }
        tbody tr:nth-child(even) { background-color: #f8f9fa; }

        @media (max-width: 850px) {
            .top-row { grid-template-columns: 1fr; }
            .event-manager-card { grid-column: span 1; }
            .event-form { flex-direction: column; }
        }
        .event-manager-card { 
        grid-column: span 2; 
        width: 100%; /* Ensure card takes full width */
    }
    
    .event-form { 
        display: flex; 
        gap: 15px; 
        margin-bottom: 25px; 
        align-items: flex-end; 
        width: 100%; /* Form stretches to card edges */
    }

    .event-input-group { 
        flex: 1; /* This makes Name and Description grow to fill space */
        display: flex;
        flex-direction: column;
    }

    /* Ensure the inputs themselves take up 100% of their flex container */
    .event-input-group input {
        width: 100%; 
        box-sizing: border-box;
    }

    /* ---------- 2. FIX: TABLE ALIGNMENT (Fixed Header Shift) ---------- */
    .table-container {
        width: 100%;
        overflow-x: auto;
    }

    table { 
        width: 100%; 
        border-collapse: collapse; 
        table-layout: fixed; /* CRITICAL: Prevents rowspan from pushing headers */
    }

    th, td { 
        padding: 15px; 
        border: 1px solid rgba(0, 0, 0, 0.1); 
        text-align: center;
        word-wrap: break-word; /* Prevents long tokens from breaking layout */
    }

    /* Assigning specific widths to headers so they never shift */
    .col-token { width: 180px; }
    .col-team { width: 100px; }
    .col-reg { width: 120px; }
    .col-dept { width: 100px; }
    .col-college { width: 150px; }
    .col-name { width: auto; }

    td[rowspan] {
        background: rgba(0, 198, 255, 0.05);
        vertical-align: middle; /* Keeps the Blue Token text centered vertically */
        font-weight: bold;
    }
    /* Specific styling for the Description box */
textarea {
    resize: vertical; /* Allows user to stretch it vertically only */
    min-height: 45px; /* Matches the height of your text inputs */
    line-height: 1.4;
    padding-top: 10px; /* Better alignment for multi-line text */
}

/* Ensure the input group doesn't break on mobile */
@media (max-width: 850px) {
    .event-input-group textarea {
        width: 100%;
        min-height: 80px; /* Give more space on mobile */
    }
}
/* Update these specific parts of your <style> */
table { 
    width: 100%; 
    border-collapse: collapse; 
    table-layout: auto; /* Change from FIXED to AUTO to allow columns to expand */
    min-width: 800px; /* Ensures space for all data */
}

th, td { 
    padding: 12px 15px; 
    border: 1px solid rgba(0, 0, 0, 0.1); 
    text-align: center;
    white-space: nowrap; /* Prevents text from wrapping into vertical lines */
}

/* Remove the specific .col-token { width: 180px; } etc. if they exist */
    </style>
</head>
<body>

<div id="toast">‚úÖ Action Successful!</div>

<div class="modal-overlay" id="confirmModal">
    <div class="modal-box">
        <h2 style="color: #ff4b2b; margin-top: 0;">Confirm Delete?</h2>
        <p>This event will be permanently removed from the system and all student registrations.</p>
        <div class="modal-btns">
            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button class="btn" style="background: #ff4b2b;" id="modalConfirmBtn">Yes, Delete</button>
        </div>
    </div>
</div>

<div class="main-container">
    <h1>üöÄ Symposium Dashboard</h1>

    <div class="stats-row">
        <div class="stat-card">
            <h3>Total Registrations</h3>
            <p id="stat-total">0</p>
        </div>
        <div class="stat-card">
            <h3>Top College</h3>
            <p id="stat-college" style="font-size: 18px;">--</p>
        </div>
        <div class="stat-card">
            <h3>Active Events</h3>
            <p id="stat-events">0</p>
        </div>
    </div>

    <div class="card event-manager-card">
        <div class="section-header">Dynamic Event Manager</div>
        <div class="event-form">
            <div class="event-input-group">
                <label>Event Name</label>
                <input type="text" id="newEventName" placeholder="e.g. Robot War">
            </div>
            <div class="event-input-group">
    <label>Description</label>
    <textarea id="newEventDesc" placeholder="Brief details" rows="2"></textarea>
</div>
            <div class="event-input-group" style="flex: 0.5;">
                <label>Type</label>
                <select id="newEventType" onchange="toggleTeamSizeInput()">
                    <option value="solo">Solo</option>
                    <option value="group">Group</option>
                </select>
            </div>
            <div class="event-input-group" id="teamSizeGroup" style="flex: 0.3; display: none;">
                <label>Size</label>
                <input type="number" id="newEventSize" value="1" min="1" max="10">
            </div>
            <button class="btn" style="width: 150px; height: 45px;" onclick="addEvent()">Add Event</button>
        </div>
        <div class="added-events-list" id="addedEventsList"></div>
    </div>


    <div class="top-row">
        <div class="card">
            <div class="chart-header">Real-time Event Distribution</div>
            <div style="flex-grow: 1; display: flex; align-items: center;">
                <canvas id="eventChart" style="max-height: 280px;"></canvas>
            </div>
        </div>

        <div class="card">
            <div class="section-header">Control Panel</div>
            <div class="controls-grid">
                <div class="filters">
                    <input type="text" id="college" placeholder="College Name">
                    <input type="text" id="department" placeholder="Department">
                    <input type="number" id="year" placeholder="Year (1-4)">
                     <input type="text" id="teamTokenFilter" placeholder="Search Team Token (e.g. T-123)" style="display: none; border-color: #e67e22;">
                    <select id="event" onchange="applyFilterConstraints()">
                        <option value="">All Events</option>
                    </select>
                    
                    <button class="btn" id="filterBtn" onclick="loadStudents()">Apply Filters</button>
                    
                    <div class="admin-config-box" id="timerContainer">
                        <label style="font-size: 11px; color: #00c6ff; text-transform: uppercase; font-weight: bold;">Symposium Date</label>
                        <p id="timerStatus" style="font-size: 10px; color: #aaa; margin: 4px 0;">Status: Current active</p>
                        <input type="datetime-local" id="adminDateInput" style="margin-top:5px; padding: 5px;" oninput="handleDateSelection()">
                        <button class="btn btn-confirm" id="confirmBtn" onclick="updateSymposiumDate()">Confirm Date</button>
                    </div>

                    <div class="admin-config-box" id="limitContainer">
                        <label style="font-size: 11px; color: #00c6ff; text-transform: uppercase; font-weight: bold;">Selection Limit</label>
                        <p id="limitStatus" style="font-size: 10px; color: #aaa; margin: 4px 0;">Max events per student</p>
                        <input type="number" id="adminLimitInput" min="1" max="6" placeholder="Limit (e.g. 3)" style="margin-top:5px; padding: 5px;" oninput="handleLimitChange()">
                        <button class="btn btn-confirm" id="confirmLimitBtn" onclick="updateEventLimit()">Save Limit</button>
                    </div>
                </div>

                <div class="export-settings">
                    <div style="font-size: 12px; margin-bottom: 10px; color: #aaa; text-align: center;">Export Columns:</div>
                  <div class="column-options" style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
    <label style="font-size:12px;"><input type="checkbox" id="export-name" checked> Name</label>
    <label style="font-size:12px;"><input type="checkbox" id="export-reg" checked> Reg No</label>
    <label style="font-size:12px;"><input type="checkbox" id="export-college" checked> College</label>
    <label style="font-size:12px;"><input type="checkbox" id="export-dept" checked> Dept</label>
    <label style="font-size:12px;"><input type="checkbox" id="export-year" checked> Year</label>
    <label style="font-size:12px;"><input type="checkbox" id="export-events" checked> Events</label>
</div>
                    <button class="btn btn-csv" onclick="downloadCSV()" style="margin-top: 15px;">‚¨á Export CSV</button>
                    <button class="btn" onclick="downloadPDF()" style="background: #e74c3c;">üìï PDF</button>
                </div>
            </div>
        </div>
    </div>

    <div class="table-container">
        <table id="mainDataTable">
            <thead>
                <tr>
                    <th>Student Name</th>
                    <th>Register No</th>
                    <th>College</th>
                    <th>Dept</th>
                    <th>Year</th>
                    <th>Selected Events</th>
                </tr>
            </thead>
            <tbody id="studentTable"></tbody>
        </table>
    </div>
</div>
<script>
    (function() {
            const isLoggedIn = localStorage.getItem("adminLoggedIn");
            if (isLoggedIn !== "true") {
                // Not logged in? Redirect to login page immediately
                window.location.replace("admin-login.html");
            }
        })();
    // Add this at the top of your script
const API_BASE_URL = window.location.hostname === 'localhost' 
    ? 'http://localhost:3000' 
    : 'https://login-system-1-vcj6.onrender.com';
    let eventChart;
    let eventsList = [];
    let currentIsGroupView = false;
    let eventToDeleteIndex = null;
function logoutAdmin() {
    // Clear the login flag
    localStorage.removeItem("adminLoggedIn");
    // Redirect to login
    window.location.replace("admin-login.html");
}
    // --- 1. INITIALIZATION & SYNC ---
    async function fetchEventsFromServer() {
        try {
          const res = await fetch(`${API_BASE_URL}/events`);
            let data;
try {
  data = await res.json();
} catch {
  throw new Error("Server error. Please try again.");
}

            eventsList = data.map(e => ({
                name: e.event_name,
                desc: e.description,
                type: e.event_type,
                max_size: e.max_team_size
            }));
            renderEvents();
            loadStudents(); 
        } catch (err) { console.error("Fetch Events Error:", err); }
    }

    function renderEvents() {
        const listContainer = document.getElementById("addedEventsList");
        const eventSelect = document.getElementById("event");
        listContainer.innerHTML = "";
        eventSelect.innerHTML = '<option value="">All Events</option>';
        
        eventsList.forEach((e, index) => {
            const div = document.createElement("div");
            div.className = "event-item animated-row";
            div.innerHTML = `
                <div>
                    <h4 style="display:flex; align-items:center; gap:10px;">${e.name} 
                        <span style="font-size:10px; background:${e.type === 'group' ? '#e67e22' : '#2ecc71'}; color:white; padding:2px 6px; border-radius:4px;">${e.type}</span>
                    </h4>
                    <p>${e.desc}</p>
                </div>
                <button class="delete-event" onclick="openModal(${index})">√ó</button>`;
            listContainer.appendChild(div);

            const opt = document.createElement("option");
            opt.value = e.name;
            opt.textContent = e.name;
            eventSelect.appendChild(opt);
        });
        document.getElementById("stat-events").innerText = eventsList.length;
    }

    // --- 2. FILTER CONSTRAINTS (Now handles Team Token Visibility) ---
    function applyFilterConstraints() {
    const selectedEventName = document.getElementById("event").value;
    const selectedEventObj = eventsList.find(e => e.name === selectedEventName);
    
    // UI Elements for Filtering
    const deptInput = document.getElementById("department");
    const yearInput = document.getElementById("year");
    const tokenInput = document.getElementById("teamTokenFilter");
    
    // UI Elements for Export Checkboxes
    const yearExportLabel = document.getElementById("export-year")?.parentElement;
    const eventsExportLabel = document.getElementById("export-events")?.parentElement;

    if (selectedEventObj && selectedEventObj.type === 'group') {
        // --- GROUP VIEW LOGIC ---
        
        // 1. Disable filtering inputs that don't apply to groups
        deptInput.value = "";
        yearInput.value = "";
        deptInput.disabled = true;
        yearInput.disabled = true;
        deptInput.style.opacity = "0.4";
        yearInput.style.opacity = "0.4";
        
        // 2. Show Team Token search
        if(tokenInput) tokenInput.style.display = "inline-block";

        // 3. Hide Year and Events from Export Column options
        if(yearExportLabel) yearExportLabel.style.display = "none";
        if(eventsExportLabel) eventsExportLabel.style.display = "none";

    } else {
        // --- SOLO VIEW LOGIC ---
        
        // 1. Re-enable filtering inputs
        deptInput.disabled = false;
        yearInput.disabled = false;
        deptInput.style.opacity = "1";
        yearInput.style.opacity = "1";
        
        // 2. Hide Team Token search
        if(tokenInput) {
            tokenInput.style.display = "none";
            tokenInput.value = "";
        }

        // 3. Show Year and Events in Export options
        if(yearExportLabel) yearExportLabel.style.display = "block";
        if(eventsExportLabel) eventsExportLabel.style.display = "block";
    }
}
    // --- 3. ADD EVENT ---
    async function addEvent() {
        const name = document.getElementById("newEventName").value.trim();
        const desc = document.getElementById("newEventDesc").value.trim();
        const type = document.getElementById("newEventType").value;
        const size = (type === 'solo') ? 1 : parseInt(document.getElementById("newEventSize").value);

        if (!name || !desc) return alert("Fill name and description");

        try {
          const response = await fetch(`${API_BASE_URL}/admin/add-event`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ 
                    name: name, 
                    description: desc, 
                    type: type, 
                    max_team_size: size 
                })
            });
            const result = await response.json();
            if (result.success) {
                showToast("‚úÖ Event added!");
                document.getElementById("newEventName").value = "";
                document.getElementById("newEventDesc").value = "";
                fetchEventsFromServer();
            }
        } catch (e) { alert("Server error adding event"); }
    }

    // --- 4. DATA LOADING & RENDERING ---
    async function loadStudents() {
        const btn = document.getElementById("filterBtn");
        const selectedEventName = document.getElementById("event").value;
        const selectedEventObj = eventsList.find(e => e.name === selectedEventName);
        const tokenSearch = document.getElementById("teamTokenFilter")?.value || "";
        
        currentIsGroupView = (selectedEventObj && selectedEventObj.type === 'group');
        
        btn.innerText = "Loading...";
        btn.disabled = true;

        try {
            updateTableHeaders(currentIsGroupView);
            
            if (currentIsGroupView) {
                // Fetch Grouped Logic (Includes Token in Query)
               const res = await fetch(`${API_BASE_URL}/admin/grouped-teams?eventName=${encodeURIComponent(selectedEventName)}&college=${document.getElementById("college").value}&token=${encodeURIComponent(tokenSearch)}`);
                let data;
try {
  data = await res.json();
} catch {
  throw new Error("Server error. Please try again.");
}

                renderGroupedRows(data);
            } else {
                const params = new URLSearchParams({
                    college: document.getElementById("college").value,
                    department: document.getElementById("department").value,
                    year: document.getElementById("year").value,
                    event: selectedEventName
                });
               const res = await fetch(`${API_BASE_URL}/admin/students?` + params.toString());
               let data;
try {
  data = await res.json();
} catch {
  throw new Error("Server error. Please try again.");
}

                renderStandardRows(data);
                updateChart(data);
            }
        } catch (error) {
            console.error(error);
            showToast("‚ùå Load error");
        } finally {
            btn.innerText = "Apply Filters";
            btn.disabled = false;
        }
    }

  function updateTableHeaders(isGroupView) {
    const thead = document.querySelector("#mainDataTable thead");
    if (isGroupView) {
        thead.innerHTML = `
            <tr>
                <th class="col-token">Team Token</th>
                <th class="col-team">Team No</th>
                <th class="col-reg">Register No</th>
                <th class="col-dept">Dept</th>
                <th class="col-college">College</th>
                <th class="col-name">Student Name</th>
            </tr>`;
    } else {
        thead.innerHTML = `
            <tr>
                <th>Student Name</th>
                <th>Register No</th>
                <th>College</th>
                <th>Dept</th>
                <th>Year</th>
                <th>Selected Events</th>
            </tr>`;
    }
}

    function renderStandardRows(data) {
        const tbody = document.getElementById("studentTable");
        tbody.innerHTML = "";
        document.getElementById("stat-total").innerText = data.length;
        data.forEach(s => {
            const row = tbody.insertRow();
            row.className = "animated-row";
            row.innerHTML = `<td><b>${s.name}</b></td><td>${s.reg_no}</td><td>${s.college}</td><td>${s.department}</td><td>${s.year}</td><td>${s.events || 'None'}</td>`;
        });
    }

    function renderGroupedRows(groupedData) {
        const tbody = document.getElementById("studentTable");
        tbody.innerHTML = "";
        let totalStudentCount = 0;
        let teamCounter = 1;

        Object.keys(groupedData).forEach(token => {
            const members = groupedData[token];
            totalStudentCount += members.length;
            members.forEach((m, i) => {
                const row = tbody.insertRow();
                // Add Team_N only to the first row of a group using rowspan
                row.innerHTML = `
                    ${i === 0 ? `<td rowspan="${members.length}"><b>${token}</b></td>` : ""}
                    ${i === 0 ? `<td rowspan="${members.length}">Team_${teamCounter}</td>` : ""}
                    <td>${m.reg_no}</td><td>${m.department}</td><td>${m.college}</td><td>${m.name}</td>`;
            });
            teamCounter++;
        });
        document.getElementById("stat-total").innerText = totalStudentCount;
    }

   function downloadCSV() {
    const tbody = document.getElementById("studentTable");
    const rows = tbody.querySelectorAll("tr");
    if (rows.length === 0) return alert("No data to export!");

    const prefs = {
        name: document.getElementById("export-name").checked,
        reg: document.getElementById("export-reg").checked,
        college: document.getElementById("export-college").checked,
        dept: document.getElementById("export-dept").checked,
        year: document.getElementById("export-year").checked,
        events: document.getElementById("export-events").checked
    };

    let headers = [];
    if (currentIsGroupView) {
        headers.push("TEAM TOKEN", "TEAM NO");
        if (prefs.reg) headers.push("REG NO");
        if (prefs.dept) headers.push("DEPT");
        if (prefs.college) headers.push("COLLEGE");
        if (prefs.name) headers.push("STUDENT NAME");
    } else {
        if (prefs.name) headers.push("STUDENT NAME");
        if (prefs.reg) headers.push("REG NO");
        if (prefs.college) headers.push("COLLEGE");
        if (prefs.dept) headers.push("DEPT");
        if (prefs.year) headers.push("YEAR");
        if (prefs.events) headers.push("SELECTED EVENTS");
    }

    let csv = headers.join(",") + "\n";

    rows.forEach(row => {
        let rowData = [];
        const cells = Array.from(row.querySelectorAll("td"));

        if (currentIsGroupView) {
            const isLeader = row.querySelector("td[rowspan]");
            
            if (isLeader) {
                // First person in team: Fill Token and Team No
                rowData.push(`"${cells[0].innerText}"`);
                rowData.push(`"${cells[1].innerText}"`);
                
                // Student data starts at index 2
                if (prefs.reg) rowData.push(`"${cells[2]?.innerText || ''}"`);
                if (prefs.dept) rowData.push(`"${cells[3]?.innerText || ''}"`);
                if (prefs.college) rowData.push(`"${cells[4]?.innerText || ''}"`);
                if (prefs.name) rowData.push(`"${cells[5]?.innerText || ''}"`);
            } else {
                // Member of team: Leave Token and Team No EMPTY
                rowData.push(""); 
                rowData.push("");
                
                // Student data starts at index 0 for members
                if (prefs.reg) rowData.push(`"${cells[0]?.innerText || ''}"`);
                if (prefs.dept) rowData.push(`"${cells[1]?.innerText || ''}"`);
                if (prefs.college) rowData.push(`"${cells[2]?.innerText || ''}"`);
                if (prefs.name) rowData.push(`"${cells[3]?.innerText || ''}"`);
            }
        } else {
            // Standard Solo Logic
            if (prefs.name) rowData.push(`"${cells[0]?.innerText || ''}"`);
            if (prefs.reg) rowData.push(`"${cells[1]?.innerText || ''}"`);
            if (prefs.college) rowData.push(`"${cells[2]?.innerText || ''}"`);
            if (prefs.dept) rowData.push(`"${cells[3]?.innerText || ''}"`);
            if (prefs.year) rowData.push(`"${cells[4]?.innerText || ''}"`);
            if (prefs.events) rowData.push(`"${cells[5]?.innerText || ''}"`);
        }
        csv += rowData.join(",") + "\n";
    });

    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = `Symposium_List_${new Date().toLocaleDateString()}.csv`;
    link.click();
}

    // --- 6. EXISTING UTILS ---
    function openModal(index) {
        eventToDeleteIndex = index;
        document.getElementById("confirmModal").style.display = "flex";
        document.getElementById("modalConfirmBtn").onclick = deleteEvent;
    }
    function closeModal() { document.getElementById("confirmModal").style.display = "none"; }

    async function deleteEvent() {
        const eventName = eventsList[eventToDeleteIndex].name;
        try {
            const res = await fetch(`${API_BASE_URL}/admin/delete-event?name=${encodeURIComponent(eventName)}`, { method: "DELETE" });
            if (res.ok) {
                showToast("üóëÔ∏è Event Deleted");
                closeModal();
                fetchEventsFromServer();
            }
        } catch (e) { alert("Delete failed"); }
    }

    function updateChart(data) {
        const counts = {};
        data.forEach(s => {
            if(s.events && s.events !== 'No events') {
                s.events.split(', ').forEach(e => {
                    const name = e.split(' [')[0];
                    counts[name] = (counts[name] || 0) + 1;
                });
            }
        });
        const ctx = document.getElementById('eventChart').getContext('2d');
        if (eventChart) eventChart.destroy();
        eventChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: Object.keys(counts),
                datasets: [{ label: 'Registrations', data: Object.values(counts), backgroundColor: '#00c6ff' }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }

    function showToast(msg) {
        const t = document.getElementById("toast");
        if(t) {
            t.innerText = msg; t.style.display = "block";
            setTimeout(() => t.style.display = "none", 3000);
        }
    }
    
    function toggleTeamSizeInput() {
        const type = document.getElementById("newEventType").value;
        const group = document.getElementById("teamSizeGroup");
        if(group) group.style.display = (type === 'group') ? 'block' : 'none';
    }

    function handleLimitChange() { document.getElementById("confirmLimitBtn").style.display = "block"; }
    function handleDateSelection() { document.getElementById("confirmBtn").style.display = "block"; }

    async function updateEventLimit() {
        const val = document.getElementById("adminLimitInput").value;
        await fetch(`${API_BASE_URL}/api/settings`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ limit: val })
        });
        showToast("‚úÖ Limit Saved");
        document.getElementById("confirmLimitBtn").style.display = "none";
    }

    function updateSymposiumDate() {
        const val = document.getElementById("adminDateInput").value;
       fetch(`${API_BASE_URL}/api/settings`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ deadline: val })
        }).then(() => {
            showToast("üìÖ Date Updated");
            document.getElementById("confirmBtn").style.display = "none";
        });
    }
   function downloadPDF() {
    const eventName = document.getElementById("event").value || "General_Report";
    
    // 1. Capture preferences
    const prefs = {
        name: document.getElementById("export-name")?.checked || false,
        reg: document.getElementById("export-reg")?.checked || false,
        college: document.getElementById("export-college")?.checked || false,
        dept: document.getElementById("export-dept")?.checked || false,
        year: document.getElementById("export-year")?.checked || false,
        events: document.getElementById("export-events")?.checked || false
    };

    // 2. Map indices DYNAMICALLY (Fixed ID from adminTable to mainDataTable)
    const headCells = Array.from(document.querySelectorAll("#mainDataTable thead th"));
    const tableHeaders = headCells.map(th => th.innerText.toLowerCase().trim());
    
    const idx = {
        teamToken: tableHeaders.findIndex(h => h.includes("token")),
        teamNo: tableHeaders.findIndex(h => h.includes("team no")),
        reg: tableHeaders.findIndex(h => h.includes("register") || h.includes("reg no")),
        name: tableHeaders.findIndex(h => h.includes("student name") || h.includes("name")),
        dept: tableHeaders.findIndex(h => h.includes("dept")),
        college: tableHeaders.findIndex(h => h.includes("college")),
        year: tableHeaders.findIndex(h => h.includes("year")),
        events: tableHeaders.findIndex(h => h.includes("events") || h.includes("selected"))
    };

    // 3. Build HTML Header for PDF
    let printTable = `<table border="1"><thead><tr>`;
    if (currentIsGroupView) {
        printTable += `<th>Team Token</th><th>Team No</th>`;
    }
    if (prefs.reg) printTable += `<th>Register No</th>`;
    if (prefs.name) printTable += `<th>Student Name</th>`;
    if (prefs.dept) printTable += `<th>Department</th>`;
    if (prefs.college) printTable += `<th>College</th>`;
    if (prefs.year && !currentIsGroupView) printTable += `<th>Year</th>`;
    if (prefs.events && !currentIsGroupView) printTable += `<th>Events</th>`;
    printTable += `</tr></thead><tbody>`;

    // 4. Build Rows
    const rows = document.querySelectorAll("#studentTable tr");
    
    // Tracking for group view rowspan
    let lastToken = "";
    let lastTeamNo = "";

    rows.forEach(row => {
        const cells = Array.from(row.cells);
        if (cells.length === 0) return; 

        printTable += `<tr>`;

        if (currentIsGroupView) {
            // Group logic: Indexing changes if the row has rowspan (Leader) or not (Member)
            const isLeader = cells.length > 4; 
            
            if (isLeader) {
                lastToken = cells[0].innerText;
                lastTeamNo = cells[1].innerText;
                printTable += `<td style="background:#f9f9f9;"><b>${lastToken}</b></td><td>${lastTeamNo}</td>`;
                
                // For Leaders, the data is shifted by 2
                if (prefs.reg) printTable += `<td>${cells[2]?.innerText || ''}</td>`;
                if (prefs.name) printTable += `<td>${cells[5]?.innerText || ''}</td>`;
                if (prefs.dept) printTable += `<td>${cells[3]?.innerText || ''}</td>`;
                if (prefs.college) printTable += `<td>${cells[4]?.innerText || ''}</td>`;
            } else {
                // For Members, data starts at index 0
                printTable += `<td></td><td></td>`; 
                if (prefs.reg) printTable += `<td>${cells[0]?.innerText || ''}</td>`;
                if (prefs.name) printTable += `<td>${cells[3]?.innerText || ''}</td>`;
                if (prefs.dept) printTable += `<td>${cells[1]?.innerText || ''}</td>`;
                if (prefs.college) printTable += `<td>${cells[2]?.innerText || ''}</td>`;
            }
        } else {
            // Solo logic: Mapping based on your specific standard row order
            // [0:Name, 1:Reg, 2:College, 3:Dept, 4:Year, 5:Events]
            if (prefs.reg) printTable += `<td>${cells[1]?.innerText || ''}</td>`;
            if (prefs.name) printTable += `<td>${cells[0]?.innerText || ''}</td>`;
            if (prefs.dept) printTable += `<td>${cells[3]?.innerText || ''}</td>`;
            if (prefs.college) printTable += `<td>${cells[2]?.innerText || ''}</td>`;
            if (prefs.year) printTable += `<td>${cells[4]?.innerText || ''}</td>`;
            if (prefs.events) printTable += `<td>${cells[5]?.innerText || ''}</td>`;
        }
        printTable += `</tr>`;
    });

    printTable += `</tbody></table>`;

    // 5. Open and Print
    const printWindow = window.open('', '', 'height=800,width=1000');
    printWindow.document.write(`
        <html><head><title>Symposium Report</title><style>
            body { font-family: sans-serif; padding: 20px; }
            table { width: 100%; border-collapse: collapse; }
            th, td { border: 1px solid #000; padding: 8px; text-align: left; font-size: 12px; }
            th { background: #eee; }
            h2, h3 { text-align: center; }
        </style></head><body>
            <h2>Symposium Registration List</h2>
            <h3>Event: ${eventName.toUpperCase().replace('_', ' ')}</h3>
            ${printTable}
        </body></html>
    `);
    printWindow.document.close();
    setTimeout(() => { printWindow.print(); printWindow.close(); }, 500);
}
    window.onload = () => {
    const isAdmin = localStorage.getItem("adminLoggedIn");
    
    // Check: If no badge AND we aren't testing locally, kick them out
    if (!isAdmin && window.location.hostname !== 'localhost') {
        alert("üîí Access Denied. Please Login.");
        window.location.href = "admin-login.html"; // Redirect to login page
    } else {
        // If they have the badge, proceed to load data
        fetchEventsFromServer();
    }
};
</script>
</body>
</html>